<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ganesh Billing</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#f1f5f9}
#loginPage,#dashboardPage{position:fixed;inset:0;display:none}

/* LOGIN */
#loginPage{display:flex;align-items:center;justify-content:center}
.login-box{background:#fff;padding:25px;width:320px;border-radius:8px;box-shadow:0 0 10px #0002}
input,textarea,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:4px}
button{padding:8px 12px;border:none;border-radius:4px;cursor:pointer}
.btn-primary{background:#4f46e5;color:#fff}
.btn-danger{background:#dc2626;color:#fff}
.btn-outline{border:1px solid #4f46e5;background:#fff;color:#4f46e5}
.btn-small{padding:5px 8px;font-size:12px}

/* DASHBOARD */
#dashboardPage{display:flex}
.sidebar{width:230px;background:#0f172a;color:#fff;display:flex;flex-direction:column}
.menu{padding:14px;cursor:pointer}
.menu:hover,.menu.active{background:#1e293b}
.submenu{padding:12px 30px;font-size:14px;cursor:pointer}
.submenu:hover,.submenu.active{background:#1e293b}
.profile{margin-top:auto;padding:14px;border-top:1px solid #1e293b}

.main{flex:1;padding:25px;overflow:auto}
.content{max-width:1200px;margin:auto;display:none}
.content.active{display:block}
.card{background:#fff;padding:25px;border-radius:8px;box-shadow:0 0 10px #0001;margin-bottom:20px}

.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid #ddd;padding:8px;font-size:14px}
.table th{background:#f3f4f6}

/* MODAL */
.modal{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center;z-index:100}
.modal-box{background:#fff;width:900px;max-height:90vh;overflow:auto;border-radius:8px;padding:20px}
.modal-header{display:flex;justify-content:space-between;align-items:center}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage">
  <div class="login-box">
    <h2>Login</h2>
    <input id="loginMobile" placeholder="Mobile Number">
    <input id="loginPassword" type="password" placeholder="Password">
    <button class="btn-primary" style="width:100%" onclick="login()">Login</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage">
  <div class="sidebar">

    <div class="menu active" onclick="showTab('home',this)">üè† Dashboard</div>

    <div class="menu" onclick="toggleMenu('partySub','partyArrow')">

      <!-- NEW: SALES INVOICE -->
  <div class="menu" onclick="showTab('salesInvoice', this)">
    üßæ Create Sales Invoice
  </div>
      
      üë• Parties <span style="float:right" id="partyArrow">‚ñ∏</span>
    </div>
    <div id="partySub" style="display:none">
      <div class="submenu">‚ûï Add Party</div>
      <div class="submenu">‚úèÔ∏è Edit Party</div>
    </div>

    <div class="menu" onclick="toggleMenu('itemSub','itemArrow')">
      üì¶ Items <span style="float:right" id="itemArrow">‚ñ∏</span>
    </div>
    <div id="itemSub" style="display:none">
      <div class="submenu" onclick="openItemModal()">‚ûï Create Item</div>
      <div class="submenu" onclick="showTab('itemsList',this)">üìã Items List</div>
    </div>

    <div class="menu" onclick="showTab('personal',this)">üë§ Personal Details</div>

    <!-- PROFILE + LOGOUT -->
    <div class="profile">
      <div id="userName">User</div>
      <small>Online</small><br><br>
      <button class="btn-danger" style="width:100%" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="main">

    <div id="home" class="content active">
      <div class="card"><h2>Welcome üëã</h2></div>
    </div>

    <div id="personal" class="content">
      <div class="card">
        <h2>Personal / Business Details</h2>
        <input id="business" placeholder="Business Name">
        <input id="mobile" placeholder="Mobile Number">
        <input id="gst" placeholder="GST Number">
        <input id="email" placeholder="Email">
        <textarea id="address" placeholder="Address"></textarea>
        <button class="btn-primary" onclick="saveProfile()">Save</button>
      </div>
    </div>

    <div id="itemsList" class="content">
      <div class="card">
        <div style="display:flex;justify-content:space-between">
          <input id="searchItem" placeholder="Search Item" onkeyup="filterItems()">
          <div>
            <input type="file" id="excelFile">
            <button class="btn-outline" onclick="bulkUpload()">Bulk Upload</button>
            <button class="btn-primary" onclick="openItemModal()">Create Item</button>
          </div>
        </div>
      </div>

      <div class="card">
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Code</th>
              <th>HSN</th>
              <th>GST%</th>
              <th>Sale</th>
              <th>Purchase</th>
              <th>MRP</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="itemsTable"></tbody>
        </table>
      </div>
    </div>


    <!-- SALES INVOICE PAGE -->
<div id="salesInvoice" class="content">

  <!-- HEADER -->
  <div class="card">
    <h2>üßæ Create Sales Invoice</h2>
  </div>

  <!-- TOP SECTION -->
  <div class="card" style="display:flex;gap:20px">

    <!-- LEFT: BILL TO -->
    <div style="flex:1">
      <h3>Bill To</h3>

      <div style="border:2px dashed #4f46e5;padding:30px;text-align:center;border-radius:6px;cursor:pointer">
        + Add Party
      </div>
    </div>

    <!-- RIGHT: INVOICE DETAILS -->
    <div style="width:300px">
      <label>Sales Invoice No</label>
      <input id="invNumber" placeholder="Auto">

      <label>Invoice Date</label>
     <input type="date" id="invDate">
      
      <div style="margin:10px 0;border:2px dashed #4f46e5;padding:10px;text-align:center;border-radius:6px;cursor:pointer">
        + Add Due Date
      </div>

      <label>E-Way Bill No</label>
      <input id="ewayBill">

      <label>Vehicle No</label>
      <input id="vehicleNo">
    </div>

  </div>

  <!-- ITEMS SECTION -->
  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>No</th>
          <th>Items / Services</th>
          <th>HSN / SAC</th>
          <th>Qty</th>
          <th>Price (‚Çπ)</th>
          <th>Discount</th>
          <th>Tax</th>
          <th>Amount (‚Çπ)</th>
        </tr>
      </thead>
      <tbody id="invoiceItemsBody">
      <tr onclick="addInvoiceRow()">

        <tr onclick="addInvoiceRow()">
  <td colspan="8" style="text-align:center;border:2px dashed #4f46e5;padding:15px;cursor:pointer">
    + Add Item
  </td>
</tr>


      </tbody>
    </table>
  </div>

  <!-- BOTTOM SECTION -->
  <div class="card" style="display:flex;gap:20px">

    <!-- LEFT -->
    <div style="flex:1">
      <a href="#">+ Add Notes</a>

      <h4 style="margin-top:20px">Terms and Conditions</h4>
      <textarea rows="4">
1. Goods once sold will not be taken back.
2. Subject to local jurisdiction.
      </textarea>

      <h4 style="margin-top:20px">Bank Details</h4>
      <p>
        Account Name: Ganesh Enterprises<br>
        Bank: Axis Bank<br>
        IFSC: UTIB0001447
      </p>
    </div>

    <!-- RIGHT -->
    <div style="width:300px">
    <p>Subtotal: ‚Çπ <span id="invSubtotal">0</span></p>
<p>Tax: ‚Çπ <span id="invTax">0</span></p>
<p>Discount: ‚Çπ <span id="invDiscount">0</span></p>
<hr>
<h3>Total Amount: ‚Çπ <span id="invTotal">0</span></h3>

      <button class="btn-primary"
        style="width:100%;margin-top:15px"
        onclick="saveSalesInvoice()">
  Save Sales Invoice
</button>

    </div>

  </div>

</div>

    
  </div>
</div>

<!-- ITEM MODAL -->
<div class="modal" id="itemModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Create / Edit Item</h3>
      <button onclick="closeItemModal()">‚úñ</button>
    </div>

    <input id="itemName" placeholder="Item Name *">
    <input id="itemDesc" placeholder="Description">
    <input id="itemCategory" placeholder="Category">
    <input id="itemCode" placeholder="Item Code">
    <input id="itemHSN" placeholder="HSN Code">
    <input id="itemGST" placeholder="GST %">
    <input id="salePrice" placeholder="Sales Price">
    <select id="taxType">
      <option>Exclusive</option>
      <option>Inclusive</option>
    </select>
    <input id="purchasePrice" placeholder="Purchase Price">
    <input id="itemMRP" placeholder="MRP">

    <button class="btn-primary" onclick="saveItem()">Save Item</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, setDoc, doc, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  function calculateInvoiceTotals() {
  let subtotal = 0;
  let totalTax = 0;
  let totalDiscount = 0;

  const rows = document.querySelectorAll("#invoiceItemsBody tr");

  rows.forEach(tr => {
    const inputs = tr.querySelectorAll("input");
    if (inputs.length === 0) return;

    const qty = Number(inputs[3]?.value || 0);
    const price = Number(inputs[4]?.value || 0);
    const discount = Number(inputs[5]?.value || 0);
    const gst = Number(inputs[6]?.value || 0);

    const rowBase = qty * price;
    const rowAfterDiscount = rowBase - discount;
    const rowTax = rowAfterDiscount * gst / 100;

    subtotal += rowAfterDiscount;
    totalTax += rowTax;
    totalDiscount += discount;
  });

  invSubtotal.innerText = subtotal.toFixed(2);
  invTax.innerText = totalTax.toFixed(2);
  invDiscount.innerText = totalDiscount.toFixed(2);
  invTotal.innerText = (subtotal + totalTax).toFixed(2);
}

  
  
/* FIREBASE INIT */
const app = initializeApp({
  apiKey:"AIzaSyAY4MfQ5zPh60EfYmY0JoKIDQkojqNU6hs",
  authDomain:"ganeshbilling-bdada.firebaseapp.com",
  projectId:"ganeshbilling-bdada"
});
const auth=getAuth(), db=getFirestore();

let uid="", allItems=[], editId=null;

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(user){
    uid=user.uid;
    userName.innerText=user.email || "User";
    loginPage.style.display="none";
    dashboardPage.style.display="flex";
    loadItems();
  }else{
    loginPage.style.display="flex";
    dashboardPage.style.display="none";
  }
});

/* LOGIN */
window.login=async()=>{
  if(!loginMobile.value||loginPassword.value.length<6)
    return alert("Invalid login");
  try{
    await signInWithEmailAndPassword(auth,loginMobile.value+"@mobile.local",loginPassword.value);
  }catch(e){alert(e.message)}
};

/* LOGOUT */
window.logout=async()=>{
  try{
    await signOut(auth);
    allItems=[];
    itemsTable.innerHTML="";
  }catch(e){
    alert("Logout failed: "+e.message);
  }
};

/* SIDEBAR */
window.toggleMenu=(id,arrow)=>{
  const el=document.getElementById(id);
  const ar=document.getElementById(arrow);
  el.style.display=el.style.display==="none"?"block":"none";
  ar.innerText=el.style.display==="none"?"‚ñ∏":"‚ñæ";
};
window.showTab=(id,el)=>{
  document.querySelectorAll(".content").forEach(c=>c.classList.remove("active"));
  document.querySelectorAll(".menu,.submenu").forEach(m=>m.classList.remove("active"));
  el.classList.add("active");
  document.getElementById(id).classList.add("active");
};

/* PROFILE */
window.saveProfile=async()=>{
  try{
    await setDoc(doc(db,"profiles",uid),{
      business:business.value,
      mobile:mobile.value,
      gst:gst.value,
      email:email.value,
      address:address.value
    });
    alert("Saved");
  }catch(e){alert(e.message)}
};

/* MODAL */
window.openItemModal=()=>{
  resetForm();
  itemModal.style.display="flex";
};
window.closeItemModal=()=>itemModal.style.display="none";

function resetForm(){
  editId=null;
  document.querySelectorAll("#itemModal input").forEach(i=>i.value="");
}

/* SAVE ITEM */
window.saveItem=async()=>{
  if(!itemName.value.trim()) return alert("Item name required");
  const data={
    name:itemName.value.trim(),
    description:itemDesc.value,
    category:itemCategory.value,
    code:itemCode.value,
    hsn:itemHSN.value,
    gst:Number(itemGST.value||0),
    salePrice:Number(salePrice.value||0),
    taxType:taxType.value,
    purchasePrice:Number(purchasePrice.value||0),
    mrp:Number(itemMRP.value||0)
  };
  try{
    if(editId)
      await updateDoc(doc(db,"items",uid,"list",editId),data);
    else
      await addDoc(collection(db,"items",uid,"list"),{...data,createdAt:new Date()});
    closeItemModal();loadItems();
  }catch(e){alert(e.message)}
};

  function createItemSearchInput(rowId) {
  return `
    <input type="text"
      placeholder="Search item..."
      onkeyup="searchItem(this, '${rowId}')"
      style="width:100%">
    <div class="item-suggestions" style="position:relative"></div>
  `;
}


/* LOAD ITEMS */
async function loadItems(){
  allItems=[];
  const snap=await getDocs(collection(db,"items",uid,"list"));
  snap.forEach(d=>allItems.push({id:d.id,...d.data()}));
  renderItems(allItems);
}

/* RENDER */
function renderItems(list){
  itemsTable.innerHTML="";
  list.forEach(i=>{
    itemsTable.innerHTML+=`
      <tr>
        <td>${i.name}</td>
        <td>${i.code||""}</td>
        <td>${i.hsn||""}</td>
        <td>${i.gst||0}</td>
        <td>${i.salePrice||0}</td>
        <td>${i.purchasePrice||0}</td>
        <td>${i.mrp||0}</td>
        <td>
          <button onclick="editItem('${i.id}')" class="btn-small">‚úèÔ∏è</button>
          <button onclick="deleteItem('${i.id}')" class="btn-small btn-danger">üóë</button>
        </td>
      </tr>`;
  });
}

window.editItem=id=>{
  const i=allItems.find(x=>x.id===id);
  if(!i) return;
  editId=id;
  itemName.value=i.name;
  itemDesc.value=i.description;
  itemCategory.value=i.category;
  itemCode.value=i.code;
  itemHSN.value=i.hsn;
  itemGST.value=i.gst;
  salePrice.value=i.salePrice;
  purchasePrice.value=i.purchasePrice;
  itemMRP.value=i.mrp;
  taxType.value=i.taxType;
  openItemModal();
};

window.deleteItem=async id=>{
  if(confirm("Delete item?")){
    await deleteDoc(doc(db,"items",uid,"list",id));
    loadItems();
  }
};



  window.addInvoiceRow = () => {
  const rowId = "row_" + Date.now();

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>#</td>
    <td>${createItemSearchInput(rowId)}</td>
    <td><input disabled></td>
    <td><input type="number" value="1" min="1" oninput="recalculateRow(this)"></td>
    <td><input type="number" value="0" oninput="recalculateRow(this)"></td>
    <td><input type="number" value="0" oninput="recalculateRow(this)"></td>
    <td><input disabled></td>
    <td><input disabled></td>
  `;

  invoiceItemsBody.insertBefore(tr, invoiceItemsBody.lastElementChild);
};


  window.searchItem = (input, rowId) => {
  const query = input.value.toLowerCase();
  const box = input.nextElementSibling;
  box.innerHTML = "";

  if (!query) return;

  const matches = allItems.filter(i =>
    (i.name || "").toLowerCase().includes(query)
  );

  matches.forEach(i => {
    const div = document.createElement("div");
    div.style.border = "1px solid #ccc";
    div.style.padding = "5px";
    div.style.cursor = "pointer";
    div.innerText = i.name;

    div.onclick = () => selectItem(i, input);
    box.appendChild(div);
  });

  if (matches.length === 0) {
    const div = document.createElement("div");
    div.style.padding = "5px";
    div.style.cursor = "pointer";
    div.innerText = "+ Create New Item";
    div.onclick = () => openItemModal();
    box.appendChild(div);
  }
};


  function selectItem(item, input) {
  const tr = input.closest("tr");

  input.value = item.name;
  tr.children[2].querySelector("input").value = item.hsn || "";
  tr.children[4].querySelector("input").value = item.salePrice || 0;
  tr.children[6].querySelector("input").value = item.gst || 0;

  input.nextElementSibling.innerHTML = "";
  recalculateRow(tr);
}

  window.recalculateRow = (el) => {
  const tr = el.closest("tr");

  const qty = Number(tr.children[3].querySelector("input").value || 0);
  const price = Number(tr.children[4].querySelector("input").value || 0);
  const discount = Number(tr.children[5].querySelector("input").value || 0);
  const gst = Number(tr.children[6].querySelector("input").value || 0);

  const base = qty * price - discount;
  const tax = base * gst / 100;
  const total = base + tax;

  tr.children[7].querySelector("input").value = total.toFixed(2);
    calculateInvoiceTotals();
};


/* SEARCH */
window.filterItems=()=>{
  const q=searchItem.value.toLowerCase();
  renderItems(allItems.filter(i=>(i.name||"").toLowerCase().includes(q)));
};

/* BULK UPLOAD */
window.bulkUpload=()=>{
  const f=excelFile.files[0];
  if(!f) return alert("Select Excel");
  const r=new FileReader();
  r.onload=async e=>{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
    const batch=writeBatch(db);
    rows.forEach(r=>{
      if(!r["Item Name*"]) return;
      batch.set(doc(collection(db,"items",uid,"list")),{
        name:r["Item Name*"],
        description:r["Description"],
        category:r["Category"],
        code:r["Item code"],
        hsn:r["HSN Code"],
        gst:Number(r["GST Tax Rate(%)"]||0),
        salePrice:Number(r["Sales Price"]||0),
        taxType:r["Sales Tax inclusive"]||"Exclusive",
        purchasePrice:Number(r["Purchase Price"]||0),
        mrp:Number(r["MRP"]||0),
        createdAt:new Date()
      });
    });
    await batch.commit();
    loadItems();
    alert("Bulk upload done");
  };
  r.readAsBinaryString(f);
};


  function collectInvoiceItems() {
  const rows = document.querySelectorAll("#invoiceItemsBody tr");
  const items = [];

  rows.forEach(tr => {
    const inputs = tr.querySelectorAll("input");
    if (inputs.length === 0) return;

    items.push({
      name: inputs[0].value,
      hsn: inputs[1].value,
      qty: Number(inputs[3].value || 0),
      price: Number(inputs[4].value || 0),
      discount: Number(inputs[5].value || 0),
      gst: Number(inputs[6].value || 0),
      amount: Number(inputs[7].value || 0)
    });
  });

  return items;
}

window.saveSalesInvoice = async () => {

  const items = collectInvoiceItems();
  if (items.length === 0) {
    alert("Please add at least one item");
    return;
  }

  if (!invDate.value) {
    alert("Invoice date required");
    return;
  }

  const invoiceData = {
    invoiceNo: invNumber.value || ("INV-" + Date.now()),
    invoiceDate: invDate.value,
    ewayBill: ewayBill.value,
    vehicleNo: vehicleNo.value,

    items: items,

    subtotal: Number(invSubtotal.innerText),
    tax: Number(invTax.innerText),
    discount: Number(invDiscount.innerText),
    total: Number(invTotal.innerText),

    createdAt: new Date()
  };

  try {
    await addDoc(
      collection(db, "salesInvoices", uid, "list"),
      invoiceData
    );

    alert("Sales Invoice Saved Successfully ‚úÖ");
    resetInvoicePage();

  } catch (e) {
    alert("Error: " + e.message);
  }
};

function resetInvoicePage() {
  invoiceItemsBody.innerHTML = `
    <tr onclick="addInvoiceRow()">
      <td colspan="8"
          style="text-align:center;border:2px dashed #4f46e5;padding:15px;cursor:pointer">
        + Add Item
      </td>
    </tr>`;

  invNumber.value = "";
  invDate.value = "";
  ewayBill.value = "";
  vehicleNo.value = "";

  invSubtotal.innerText = "0";
  invTax.innerText = "0";
  invDiscount.innerText = "0";
  invTotal.innerText = "0";
}


  
</script>

</body>
</html>
