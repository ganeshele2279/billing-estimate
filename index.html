<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ganesh Billing</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui, Arial, sans-serif;
  background:#f5f7fb;
}
.hidden{display:none}
.flex{display:flex;gap:10px}
.card{
  background:#fff;
  padding:16px;
  border-radius:10px;
  margin-bottom:16px;
}
input,select,textarea{
  width:100%;
  padding:10px;
  margin-bottom:10px;
}
button{
  padding:10px 14px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.btn-primary{background:#4f46e5;color:#fff}
.btn-outline{border:1px solid #4f46e5;background:#fff;color:#4f46e5}

/* LOGIN */
#loginPage{
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* DASHBOARD */
#dashboardPage{
  display:flex;
  min-height:100vh;
}
.sidebar{
  width:230px;
  background:#0f172a;
  color:#fff;
  position:fixed;
  top:0;left:0;bottom:0;
  padding:12px;
}
.menu{
  padding:10px;
  cursor:pointer;
  border-radius:6px;
}
.menu:hover{background:#1e293b}
.submenu{
  padding:8px 28px;
  font-size:14px;
  cursor:pointer;
}
.submenu:hover{background:#334155}
.main{
  margin-left:230px;
  padding:20px;
  width:calc(100% - 230px);
}
.content{display:none}

/* TABLE */
.table{
  width:100%;
  border-collapse:collapse;
}
.table th,.table td{
  border-bottom:1px solid #ddd;
  padding:8px;
  text-align:left;
}
.badge{
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
}
.paid{background:#dcfce7;color:#166534}
.unpaid{background:#fee2e2;color:#991b1b}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-box{
  background:#fff;
  padding:20px;
  width:420px;
  border-radius:10px;
}
</style>
</head>

<body>

<!-- LOGIN PAGE -->
<div id="loginPage">
  <div class="card" style="width:320px">
    <h2>Login</h2>
    <input id="loginMobile" placeholder="Mobile Number">
    <input id="loginPassword" type="password" placeholder="Password">
    <button class="btn-primary" onclick="login()">Login</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage" class="hidden">

  <div class="sidebar">
    <h3>Ganesh Billing</h3>

    <div class="menu" onclick="showTab('personal')">Personal Details</div>

    <div class="menu" onclick="toggleMenu('partySub')">Parties ▸</div>
    <div id="partySub" class="hidden">
      <div class="submenu" onclick="showTab('addParty')">Add Party</div>
      <div class="submenu" onclick="showTab('partyList')">Edit Party</div>
    </div>

    <div class="menu" onclick="toggleMenu('itemSub')">Items ▸</div>
    <div id="itemSub" class="hidden">
      <div class="submenu" onclick="showTab('itemList')">Items List</div>
    </div>

    <div class="menu" onclick="toggleMenu('salesSub')">Sales ▸</div>
    <div id="salesSub" class="hidden">
      <div class="submenu" onclick="showTab('salesInvoices')">Sales Invoices</div>
    </div>

    <div class="menu" onclick="toggleMenu('settingsSub')">Settings ▸</div>
    <div id="settingsSub" class="hidden">
      <div class="submenu" onclick="showTab('manageBusiness')">Manage Business</div>
      <div class="submenu" onclick="showTab('fontSettings')">Font Style</div>
    </div>

    <div class="menu" onclick="logout()">Logout</div>
  </div>

  <div class="main">

    <!-- PERSONAL -->
    <div id="personal" class="content card">
      <h2>Personal / Business Details</h2>
      <input placeholder="Business Name">
      <input placeholder="Mobile">
      <input placeholder="GST">
      <input placeholder="Email">
      <textarea placeholder="Address"></textarea>
    </div>

    <!-- ADD PARTY -->
    <div id="addParty" class="content card">
      <h2>Add Party</h2>
      <input id="pName" placeholder="Party Name">
      <input id="pMobile" placeholder="Mobile">
      <button class="btn-primary" onclick="saveParty()">Save Party</button>
    </div>

    <!-- PARTY LIST -->
    <div id="partyList" class="content card">
      <h2>Party List</h2>
      <table class="table"><tbody id="partyTable"></tbody></table>
    </div>

    <!-- ITEMS -->
    <div id="itemList" class="content card">
      <h2>Items</h2>
      <table class="table"><tbody id="itemTable"></tbody></table>
    </div>

    <!-- SALES -->
    <div id="salesInvoices" class="content">
      <div class="flex">
        <div class="card">Total ₹ <span id="totalSales">0</span></div>
        <div class="card">Paid ₹ <span id="paidSales">0</span></div>
        <div class="card">Unpaid ₹ <span id="unpaidSales">0</span></div>
      </div>
      <button class="btn-primary" onclick="openInvoice()">Create Invoice</button>
      <table class="table"><tbody id="invoiceTable"></tbody></table>
    </div>

    <!-- SETTINGS -->
    <div id="manageBusiness" class="content card">
      <h2>Manage Business</h2>
      <input id="bizName" placeholder="Business Name">
      <input id="bizPhone" placeholder="Phone">
      <input id="bizGST" placeholder="GST">
      <button class="btn-primary" onclick="saveBusiness()">Save</button>
    </div>

    <div id="fontSettings" class="content card">
      <h2>Font Style</h2>
      <select onchange="applyFont(this.value)">
        <option value="system-ui">Default</option>
        <option value="Arial">Arial</option>
        <option value="Roboto">Roboto</option>
        <option value="Poppins">Poppins</option>
      </select>
    </div>

  </div>
</div>

<!-- INVOICE MODAL -->
<div id="invoiceModal" class="modal">
  <div class="modal-box">
    <h3>Create Invoice</h3>
    <input id="invParty" placeholder="Party Name">
    <input id="invAmount" placeholder="Amount">
    <select id="invStatus">
      <option>Paid</option>
      <option>Unpaid</option>
    </select>
    <button class="btn-primary" onclick="saveInvoice()">Save</button>
    <button onclick="closeInvoice()">Cancel</button>
  </div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {getAuth,signInWithEmailAndPassword,onAuthStateChanged,signOut} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {getFirestore,collection,addDoc,getDocs,setDoc,doc} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyAY4MfQ5zPh60EfYmY0JoKIDQkojqNU6hs",
  authDomain:"ganeshbilling-bdada.firebaseapp.com",
  projectId:"ganeshbilling-bdada"
});
const auth=getAuth(), db=getFirestore();
let uid="";

/* AUTH – LOCKED */
onAuthStateChanged(auth,user=>{
  if(user){
    uid=user.uid;
    loginPage.style.display="none";
    dashboardPage.classList.remove("hidden");
    showTab("personal");
    loadItems();
    loadInvoices();
  }else{
    dashboardPage.classList.add("hidden");
    loginPage.style.display="flex";
  }
});

/* AUTH ACTIONS */
window.login=()=>signInWithEmailAndPassword(
  auth,
  loginMobile.value+"@mobile.local",
  loginPassword.value
);
window.logout=()=>signOut(auth);

/* UI */
window.showTab=id=>{
  document.querySelectorAll(".content").forEach(c=>c.style.display="none");
  document.getElementById(id).style.display="block";
};
window.toggleMenu=id=>{
  document.getElementById(id).classList.toggle("hidden");
};

/* PARTIES */
window.saveParty=async()=>{
  await addDoc(collection(db,"parties",uid,"list"),{
    name:pName.value,
    mobile:pMobile.value
  });
};

/* ITEMS */
async function loadItems(){
  const s=await getDocs(collection(db,"items",uid,"list"));
  itemTable.innerHTML="";
  s.forEach(d=>{
    itemTable.innerHTML+=`<tr><td>${d.data().name||""}</td></tr>`;
  });
}

/* SALES */
window.openInvoice=()=>invoiceModal.style.display="flex";
window.closeInvoice=()=>invoiceModal.style.display="none";

window.saveInvoice=async()=>{
  await addDoc(collection(db,"sales",uid,"invoices"),{
    party:invParty.value,
    amount:Number(invAmount.value),
    status:invStatus.value
  });
  closeInvoice();
  loadInvoices();
};

async function loadInvoices(){
  const s=await getDocs(collection(db,"sales",uid,"invoices"));
  let t=0,p=0,u=0;
  invoiceTable.innerHTML="";
  s.forEach(d=>{
    const i=d.data();
    t+=i.amount;
    i.status==="Paid"?p+=i.amount:u+=i.amount;
    invoiceTable.innerHTML+=`
      <tr>
        <td>${i.party}</td>
        <td>₹ ${i.amount}</td>
        <td><span class="badge ${i.status==="Paid"?"paid":"unpaid"}">${i.status}</span></td>
      </tr>`;
  });
  totalSales.innerText=t;
  paidSales.innerText=p;
  unpaidSales.innerText=u;
}

/* SETTINGS */
window.saveBusiness=async()=>{
  await setDoc(doc(db,"settings",uid),{
    name:bizName.value,
    phone:bizPhone.value,
    gst:bizGST.value
  });
};
window.applyFont=f=>{
  document.body.style.fontFamily=f;
  localStorage.setItem("appFont",f);
};
const f=localStorage.getItem("appFont");
if(f) document.body.style.fontFamily=f;
</script>

</body>
</html>
