<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ganesh Billing</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#f1f5f9}
#loginPage,#dashboardPage{position:fixed;inset:0;display:none}

/* LOGIN */
#loginPage{display:flex;align-items:center;justify-content:center}
.login-box{background:#fff;padding:25px;width:320px;border-radius:8px;box-shadow:0 0 10px #0002}
input,textarea,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:4px}
button{padding:8px 12px;border:none;border-radius:4px;cursor:pointer}
.btn-primary{background:#4f46e5;color:#fff}
.btn-danger{background:#dc2626;color:#fff}
.btn-small{padding:4px 6px;font-size:12px}

/* DASHBOARD */
#dashboardPage{display:flex}
.sidebar{width:230px;background:#0f172a;color:#fff}
.menu,.submenu{padding:14px;cursor:pointer}
.menu:hover,.submenu:hover,.active{background:#1e293b}
.main{flex:1;padding:25px;overflow:auto}
.card{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px}

.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid #ddd;padding:8px}

/* MODAL */
.modal{position:fixed;inset:0;background:#0007;display:none;align-items:center;justify-content:center}
.modal-box{background:#fff;width:600px;padding:20px;border-radius:8px}
</style>
</head>

<body>

<div id="loginPage">
  <div class="login-box">
    <h2>Login</h2>
    <input id="loginMobile" placeholder="Mobile">
    <input id="loginPassword" type="password" placeholder="Password">
    <button class="btn-primary" onclick="login()">Login</button>
  </div>
</div>

<div id="dashboardPage">
  <div class="sidebar">
    <div class="menu active" onclick="showTab('items')">üì¶ Items</div>
  </div>

  <div class="main">
    <div id="items" class="card">
      <div style="display:flex;justify-content:space-between">
        <input id="searchItem" placeholder="Search" onkeyup="filterItems()">
        <div>
          <input type="file" id="excelFile">
          <button onclick="bulkUpload()">Bulk Upload</button>
          <button class="btn-primary" onclick="openItemModal()">Add Item</button>
        </div>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Name</th><th>HSN</th><th>GST%</th>
            <th>Sale</th><th>Purchase</th><th>MRP</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="itemsTable"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="itemModal">
  <div class="modal-box">
    <h3>Item</h3>
    <input id="itemName" placeholder="Item Name*">
    <input id="itemHSN" placeholder="HSN">
    <input id="itemGST" placeholder="GST %">
    <input id="salePrice" placeholder="Sale Price">
    <input id="purchasePrice" placeholder="Purchase Price">
    <input id="itemMRP" placeholder="MRP">
    <select id="taxType">
      <option>Exclusive</option>
      <option>Inclusive</option>
    </select>
    <button class="btn-primary" onclick="saveItem()">Save</button>
    <button onclick="closeItemModal()">Cancel</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyAY4MfQ5zPh60EfYmY0JoKIDQkojqNU6hs",
  authDomain:"ganeshbilling-bdada.firebaseapp.com",
  projectId:"ganeshbilling-bdada"
});

const auth=getAuth(), db=getFirestore();
let uid="", items=[], editId=null;

onAuthStateChanged(auth,u=>{
  if(u){uid=u.uid;loginPage.style.display="none";dashboardPage.style.display="flex";loadItems();}
  else loginPage.style.display="flex";
});

window.login=async()=>{
  if(!loginMobile.value||loginPassword.value.length<6) return alert("Invalid login");
  try{
    await signInWithEmailAndPassword(auth,loginMobile.value+"@mobile.local",loginPassword.value);
  }catch(e){alert(e.message)}
};

window.openItemModal=()=>{editId=null;document.querySelectorAll("#itemModal input").forEach(i=>i.value="");itemModal.style.display="flex";}
window.closeItemModal=()=>itemModal.style.display="none";

window.saveItem=async()=>{
  if(!itemName.value.trim()) return alert("Item name required");
  const data={
    name:itemName.value.trim(),
    hsn:itemHSN.value,
    gst:Number(itemGST.value||0),
    sale:Number(salePrice.value||0),
    purchase:Number(purchasePrice.value||0),
    mrp:Number(itemMRP.value||0),
    taxType:taxType.value
  };
  try{
    if(editId) await updateDoc(doc(db,"users",uid,"items",editId),data);
    else await addDoc(collection(db,"users",uid,"items"),data);
    closeItemModal();loadItems();
  }catch(e){alert(e.message)}
};

async function loadItems(){
  items=[];itemsTable.innerHTML="";
  const snap=await getDocs(collection(db,"users",uid,"items"));
  snap.forEach(d=>items.push({id:d.id,...d.data()}));
  render(items);
}

function render(list){
  itemsTable.innerHTML="";
  list.forEach(i=>{
    itemsTable.innerHTML+=`
    <tr>
      <td>${i.name}</td><td>${i.hsn||""}</td><td>${i.gst}</td>
      <td>${i.sale}</td><td>${i.purchase}</td><td>${i.mrp}</td>
      <td>
        <button onclick="editItem('${i.id}')">‚úèÔ∏è</button>
        <button class="btn-danger" onclick="delItem('${i.id}')">üóë</button>
      </td>
    </tr>`;
  });
}

window.editItem=id=>{
  const i=items.find(x=>x.id===id);
  editId=id;
  itemName.value=i.name;itemHSN.value=i.hsn;itemGST.value=i.gst;
  salePrice.value=i.sale;purchasePrice.value=i.purchase;itemMRP.value=i.mrp;
  openItemModal();
};

window.delItem=async id=>{
  if(confirm("Delete?")) await deleteDoc(doc(db,"users",uid,"items",id)),loadItems();
};

window.filterItems=()=>render(items.filter(i=>(i.name||"").toLowerCase().includes(searchItem.value.toLowerCase())));

window.bulkUpload=async()=>{
  const f=excelFile.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async e=>{
    const wb=XLSX.read(e.target.result,{type:"binary"});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    const b=writeBatch(db);
    rows.forEach(r=>{
      if(!r["Item Name*"]) return;
      b.set(doc(collection(db,"users",uid,"items")),{
        name:r["Item Name*"],gst:Number(r["GST Tax Rate(%)"]||0),sale:Number(r["Sales Price"]||0)
      });
    });
    await b.commit();loadItems();
  };
  r.readAsBinaryString(f);
};
</script>

</body>
</html>
